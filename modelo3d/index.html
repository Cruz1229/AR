<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>AR.js con Three.js - Ejemplo Básico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: Arial, sans-serif;
        }
        canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 100;
            max-width: 300px;
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            display: none;
            z-index: 200;
        }
    </style>
</head>
<body>
    <div id="info">
        <strong>Instrucciones:</strong><br>
        1. Permite el acceso a la cámara<br>
        2. Descarga e imprime el marcador Hiro<br>
        3. Apunta la cámara hacia el marcador
    </div>
    
    <div id="error">
        <h3>Error de conexión</h3>
        <p>No se pudieron cargar los recursos de AR.js.</p>
        <p>Verifica tu conexión a internet.</p>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- AR.js para Three.js - versión más estable -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>

    <script>
        let scene, camera, renderer;
        let arToolkitSource, arToolkitContext;
        let markerRoot;
        let cube, sphere;
        let isMarkerVisible = false;
        let animationId;

        // Configuración de URLs alternativas
        const AR_CONFIG = {
            cameraParams: 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/data/camera_para.dat',
            hiroPattern: 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/data/patt.hiro'
        };

        init();

        function init() {
            try {
                setupScene();
                setupRenderer();
                setupLighting();
                setupAR(); // Esto ahora manejará la creación del contenido AR de forma asíncrona
                animate();
            } catch (error) {
                console.error('Error durante la inicialización:', error);
                showError('Error de inicialización: ' + error.message);
            }
        }

        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.Camera();
            scene.add(camera);
        }

        function setupRenderer() {
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
        }

        function setupAR() {
            updateInfo('Iniciando cámara...');

            // Configurar AR Toolkit Source
            arToolkitSource = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
            });

            arToolkitSource.init(() => {
                console.log('AR Source inicializado');
                onResize();
                updateInfo('Cámara iniciada. Cargando parámetros AR...');
                
                // Configurar AR Toolkit Context después de que la cámara esté lista
                arToolkitContext = new THREEx.ArToolkitContext({
                    cameraParametersUrl: AR_CONFIG.cameraParams,
                    detectionMode: 'mono',
                });

                arToolkitContext.init(() => {
                    console.log('AR Context inicializado');
                    camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                    updateInfo('AR inicializado. Configurando marcador...');
                    setupMarker();
                }, (error) => {
                    console.error('Error al inicializar AR Context:', error);
                    showError('Error al cargar parámetros de AR. Verifica la conexión.');
                });

            }, (error) => {
                console.error('Error al inicializar AR Source:', error);
                showError('Error al acceder a la cámara. Verifica los permisos.');
            });

            // Manejar redimensionamiento
            window.addEventListener('resize', onResize);
        }

        function setupMarker() {
            try {
                // Crear el grupo para el marcador
                markerRoot = new THREE.Group();
                scene.add(markerRoot);
                console.log('markerRoot creado exitosamente');

                // Configurar el marcador Hiro
                let markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                    type: 'pattern',
                    patternUrl: AR_CONFIG.hiroPattern,
                });

                markerControls.addEventListener('markerFound', () => {
                    isMarkerVisible = true;
                    updateInfo('¡Marcador detectado! Objetos 3D visibles.');
                    console.log('Marcador encontrado');
                });

                markerControls.addEventListener('markerLost', () => {
                    isMarkerVisible = false;
                    updateInfo('Marcador perdido. Vuelve a apuntar hacia él.');
                    console.log('Marcador perdido');
                });

                // Ahora que markerRoot está creado, podemos añadir el contenido AR
                createARContent();
                
                // Todo configurado correctamente
                updateInfo('✅ AR configurado. Busca el marcador Hiro con tu cámara.');
                console.log('Configuración completa - listo para detectar marcadores');

            } catch (error) {
                console.error('Error al configurar marcador:', error);
                showError('Error al configurar el marcador Hiro: ' + error.message);
            }
        }

        function setupLighting() {
            // Luz ambiental
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // Luz direccional
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(2, 2, 2);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
        }

        function createARContent() {
            // Verificar que markerRoot esté definido
            if (!markerRoot) {
                console.error('markerRoot no está definido. No se puede crear contenido AR.');
                return;
            }

            // Cubo multicolor animado
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const materials = [
                new THREE.MeshLambertMaterial({ color: 0xff4444 }), // Rojo
                new THREE.MeshLambertMaterial({ color: 0x44ff44 }), // Verde
                new THREE.MeshLambertMaterial({ color: 0x4444ff }), // Azul
                new THREE.MeshLambertMaterial({ color: 0xffff44 }), // Amarillo
                new THREE.MeshLambertMaterial({ color: 0xff44ff }), // Magenta
                new THREE.MeshLambertMaterial({ color: 0x44ffff })  // Cian
            ];
            
            cube = new THREE.Mesh(geometry, materials);
            cube.position.set(0, 0.5, 0);
            cube.castShadow = true;
            markerRoot.add(cube);

            // Esfera que orbita
            const sphereGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const sphereMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xffffff,
                emissive: 0x222222
            });
            sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            sphere.position.set(2, 1, 0);
            sphere.castShadow = true;
            markerRoot.add(sphere);

            // Plano base con textura
            const planeGeometry = new THREE.PlaneGeometry(5, 5);
            const planeMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x666666,
                transparent: true,
                opacity: 0.7
            });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = -Math.PI / 2;
            plane.receiveShadow = true;
            markerRoot.add(plane);

            // Pirámide adicional
            const pyramidGeometry = new THREE.ConeGeometry(0.5, 1, 8);
            const pyramidMaterial = new THREE.MeshLambertMaterial({ color: 0xff6600 });
            const pyramid = new THREE.Mesh(pyramidGeometry, pyramidMaterial);
            pyramid.position.set(-1.5, 0.5, 1);
            pyramid.castShadow = true;
            markerRoot.add(pyramid);

            console.log('Contenido AR creado exitosamente');
        }

        function onResize() {
            if (arToolkitSource && arToolkitSource.ready) {
                arToolkitSource.onResize();
                arToolkitSource.copySizeTo(renderer.domElement);
                if (arToolkitContext.arController !== null) {
                    arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
                }
            }
        }

        function animate() {
            animationId = requestAnimationFrame(animate);

            try {
                // Actualizar AR
                if (arToolkitSource && arToolkitSource.ready) {
                    arToolkitContext.update(arToolkitSource.domElement);
                }

                // Animar objetos cuando el marcador esté visible
                if (isMarkerVisible) {
                    if (cube) {
                        cube.rotation.x += 0.02;
                        cube.rotation.y += 0.03;
                    }
                    
                    if (sphere) {
                        // Hacer que la esfera orbite
                        const time = Date.now() * 0.001;
                        sphere.position.x = Math.cos(time) * 2;
                        sphere.position.z = Math.sin(time) * 2;
                        sphere.position.y = 1 + Math.sin(time * 2) * 0.3;
                    }
                }

                // Renderizar la escena
                renderer.render(scene, camera);
            } catch (error) {
                console.error('Error en animate:', error);
            }
        }

        function updateInfo(message) {
            document.getElementById('info').innerHTML = `
                <strong>Estado:</strong> ${message}<br>
                <small>Asegúrate de tener el marcador Hiro impreso</small>
            `;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = `
                <h3>⚠️ Error</h3>
                <p>${message}</p>
                <button onclick="location.reload()">Reintentar</button>
            `;
            errorDiv.style.display = 'block';
        }

        // Verificar acceso a la cámara
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    console.log('Permisos de cámara concedidos');
                    stream.getTracks().forEach(track => track.stop()); // Detener el stream de prueba
                })
                .catch(err => {
                    console.error('Error al acceder a la cámara:', err);
                    showError('No se pudo acceder a la cámara. Verifica los permisos del navegador.');
                });
        } else {
            showError('Tu navegador no soporta acceso a la cámara.');
        }

        // Limpiar recursos al cerrar
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>